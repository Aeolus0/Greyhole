Greyhole Installation Instructions
==================================

The following instructions are for Fedora 12 or Ubuntu 9/10.
If you know what you're doing, you should have no problem installing on any other Linux variant.

Amahi (http://www.amahi.org) comes with Greyhole pre-installed.
If you're looking for an easy way to try Greyhole, in a virtual machine or a spare computer, installing Amahi might be the easiest way to get a working Greyhole install.
More info about Greyhole on Amahi: http://wiki.amahi.org/index.php/Greyhole

Note: Samba 3.4.3 (and 3.3.9) fix a bug that affects Greyhole functionnality.
      See http://www.samba.org/samba/history/samba-3.4.3.html - BUG 6769: Fix symlink unlink. - https://bugzilla.samba.org/show_bug.cgi?id=6769
      With this bug present, trying to delete files on Greyhole shares will not work!
      Make sure the Samba version you use includes this fix, or isn't affected by this bug.
      Also, there have been reports that the Debian-bundled version of Samba would sometime show symlinks as 0-bytes files, to clients.
      If you have such issues, you should compile the latest Samba stable manually and use that.

1. Install the required applications: PHP 5+ (cli) with MySQL & mbstring extensions, MySQL server, Samba, rsync, GCC (etc.):

	Fedora: sudo yum -y install mysql-server php php-mysql php-mbstring samba samba-common patch gcc yum-utils php-pear rsync
	Ubuntu: sudo apt-get -y install mysql-server php5-cli php5-mysql samba samba-common samba-common-bin build-essential php-pear rsync

2. Install Greyhole (as root):

	Get the latest version from http://code.google.com/p/greyhole/downloads/list
	tar zxf greyhole-*.tar.gz
	cd greyhole-*
	GREYHOLE_INSTALL_DIR=`pwd`
	mkdir -p /var/spool/greyhole
	chmod 777 /var/spool/greyhole
	install -m 0755 -D -p initd_script.sh /etc/init.d/greyhole
	install -m 0755 -D -p greyhole /usr/bin
	install -m 0755 -D -p greyhole-dfree /usr/bin
	install -m 0750 -D -p greyhole-config-update /usr/bin
	install -m 0644 -D -p logrotate.greyhole /etc/logrotate.d/greyhole
	install -m 0644 -D -p greyhole.cron.d /etc/cron.d/greyhole
	install -m 0755 -D -p greyhole.cron.weekly /etc/cron.weekly/greyhole
	install -m 0755 -D -p greyhole.cron.daily /etc/cron.daily/greyhole
	if [ -f includes/common.php ]; then
		include_path=`php -i | grep include_path | awk -F':' '{print $NF}'`
		mkdir "$include_path/includes"
		install -m 0644 -D -p includes/common.php "$include_path/includes"
		install -m 0644 -D -p includes/sql.php "$include_path/includes"
	fi

	# What version of Samba are you running ?
	smbd --version

	# For Samba 3.4: #
		if [ -x /usr/lib64/samba/vfs/ ]; then cp samba-module/bin/greyhole-x86_64.so /usr/lib64/samba/vfs/greyhole.so; else cp samba-module/bin/greyhole-i386.so /usr/lib/samba/vfs/greyhole.so; fi
	# For Samba 3.5: #
		if [ -x /usr/lib64/samba/vfs/ ]; then cp samba-module/bin/3.5/greyhole-x86_64.so /usr/lib64/samba/vfs/greyhole.so; else cp samba-module/bin/3.5/greyhole-i386.so /usr/lib/samba/vfs/greyhole.so; fi
	
	Ubuntu (10+): install the Upstart script:
		install -m 0644 -D -p upstart.conf /etc/init/greyhole.conf
		rm /etc/init.d/greyhole

	Fedora: service smb restart
	Ubuntu: /etc/init.d/samba restart, or restart smbd

3. For Samba other than 3.4/3.5: The greyhole.so files packaged with Greyhole won't work on your system.
   You'll need to compile your own VFS module. You'll just need to compile vfs_greyhole.c, and install it.

	Fedora:
	yumdownloader --source samba
	rpm -ivh samba-3.*.fc*.src.rpm
	cd rpmbuild/SOURCES
	tar zxf samba-3.*.tar.gz
	cd samba-3.*/source3/

	Ubuntu:
	SAMBA_VERSION=`smbd --version | awk '{print $2}'`
	wget http://samba.org/samba/ftp/stable/samba-${SAMBA_VERSION}.tar.gz
	tar zxf samba-${SAMBA_VERSION}.tar.gz && rm samba-${SAMBA_VERSION}.tar.gz
	cd samba-${SAMBA_VERSION}/source3

	Both (Fedora & Ubuntu):
	./configure
	cp ${GREYHOLE_INSTALL_DIR}/samba-module/vfs_greyhole-samba-3.5.c modules/vfs_greyhole.c
	patch -p1 < ${GREYHOLE_INSTALL_DIR}/samba-module/Makefile-samba-3.5.patch
	make
	if [ -x /usr/lib64/samba/vfs/ ]; then sudo cp bin/greyhole.so /usr/lib64/samba/vfs/greyhole.so; else sudo cp bin/greyhole.so /usr/lib/samba/vfs/greyhole.so; fi

	Fedora: sudo service smb restart
	Ubuntu (< 10): sudo /etc/init.d/samba restart
	Ubuntu (10+): sudo restart smbd
	
	Note: if, for some reason, you need to compile the VFS module with Samba 3.4, use the following instead of the above cp & patch commands, after running ./configure, then continue with make:
		cp ${GREYHOLE_INSTALL_DIR}/samba-module/vfs_greyhole.c modules/
		patch -p1 < ${GREYHOLE_INSTALL_DIR}/samba-module/Makefile.patch

4. Setup Samba:

	Edit /etc/samba/smb.conf
	Change or add the following values in the [global] section:

		unix extensions = no
		follow symlinks = yes
		wide links = yes

	For each of your shares, add a 'dfree command' and 'vfs objects' lines, as seen below.

	Example share definition:
		[share_name]
		    path = /path/to/share_name
		    create mask = 0770
		    directory mask = 0770
		    read only = no
		    available = yes
		    browseable = yes
		    writable = yes
		    guest ok = no
		    printable = no
		    dfree command = /usr/bin/greyhole-dfree
		    vfs objects = greyhole

	Fedora: sudo service smb restart
	Ubuntu (< 10): sudo /etc/init.d/samba restart
	Ubuntu (10+): sudo restart smbd

5. Setup the database:

	If using MySQL:

		# Make sure your MySQL server service (mysqld) is running, and runs on boot.
		Fedora: sudo service mysqld start; sudo chkconfig mysqld on
		Ubuntu (< 10): sudo /etc/init.d/mysqld start; sudo update-rc.d mysqld defaults
		Ubuntu (10+): start mysqld
		
		# Remove the -p parameter if your MySQL root user doesn't require a password for local connections.
		mysql -u root -p -e "create database greyhole; grant all on greyhole.* to greyhole_user@localhost identified by '89y63jdwe';"
		mysql -u greyhole_user -p89y63jdwe greyhole < ${GREYHOLE_INSTALL_DIR}/schema-mysql.sql

	If using SQLite:

		sqlite -u /var/cache/greyhole.db < ${GREYHOLE_INSTALL_DIR}/schema-sqlite.sql

6. Cutomize the Greyhole configuration file:

	sudo cp ${GREYHOLE_INSTALL_DIR}/greyhole.example.conf /etc/greyhole.conf
	
	Cutomize /etc/greyhole.conf as needed.

7. For each directory you defined as 'storage_pool_directories', execute the following command, to create a hidden file in the root directory of each partition:

	touch <dir>/.greyhole_uses_this

	Example: touch /mnt/hdd0/gh/.greyhole_uses_this

	Those files will be used to differentiate an empty mount from a now-gone mount.
	i.e. Greyhole will output a warning if this file is not in the root directory where it is about to try to save a file, and it won't use that directory. This will prevent Greyhole from filling the / partition when a partition is unmounted!

8. Add Greyhole to services that start on boot:

	Fedora: sudo chkconfig --add greyhole; sudo chkconfig greyhole on
	Ubuntu (< 10): sudo update-rc.d greyhole defaults 98 20
	Ubuntu (10+): [nothing to do]

9. Work around problems with the CIFS client (as root):
    Ref: http://blog.dhampir.no/content/cifs-vfs-no-response-for-cmd-n-mid
	Note: The cron.d script added above includes an @reboot cron line to make this permanent.

	modprobe cifs
	echo 0 > /proc/fs/cifs/OplockEnabled

10. Start the Greyhole service:

	Fedora: sudo service greyhole start
	Ubuntu (< 10): sudo /etc/init.d/greyhole start
	Ubuntu (10+): sudo start greyhole


Check for errors in the Greyhole log file: /var/log/greyhole.log


If you use any application that needs to use files on your shares, you'll need to mount the shares locally, and point those applications to those mounts.
You should not touch the files in your storage pool directories.
