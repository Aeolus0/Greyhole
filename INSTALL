Greyhole Installation Instructions
==================================

The following instructions are for Fedora 12.
If you know what you're doing, you should have no problem installing on any other operating system that runs Samba (http://www.samba.org).

Note: I tried using Ubuntu 9.10 first, but had bad experiences with the CIFS server & client there... so I switched to FC12. I still have the install notes I used for Ubuntu; feel free to use that if you want.

1. Install the required applications: PHP 5 (cli) with MySQL extension, MySQL server, Samba, GCC:

	Fedora: sudo yum install mysql-server php php-mysql samba samba-common patch gcc rsyslog yum-utils
	Ubuntu: sudo apt-get install mysql-server php5-cli php5-mysql samba samba-common samba-common-bin build-essential

2. Install Greyhole (as root):

	Get the latest version from http://code.google.com/p/greyhole/downloads/list
	tar zxf greyhole-*.tar.gz
	cd greyhole-*
	GREYHOLE_INSTALL_DIR=`pwd`
	install -m 0755 -D -p initd_script.sh /etc/init.d/greyhole
	install -m 0755 -D -p greyhole-executer /usr/bin
	install -m 0755 -D -p greyhole-dfree /usr/bin
	install -m 0750 -D -p greyhole-config-update /usr/bin
	install -m 0644 -D -p logrotate.greyhole /etc/logrotate.d/greyhole
	install -m 0644 -D -p greyhole.cron.d /etc/cron.d/greyhole
	if [ `uname -i | grep 64 | wc -l` == 1 ]; then cp samba-module/bin/greyhole-x86_64.so /usr/lib64/samba/vfs/greyhole.so; else cp samba-module/bin/greyhole_i386.so /usr/lib/samba/vfs/greyhole.so; fi

3. Edit /etc/logrotate.d/syslog:
	What we want is add prerotate and postrotate instructions for /var/log/messages. So add one command in the postrotate block, and add a prerotate block. When more logs than just /var/log/messages are rotated together, the sharedscripts option needs to be there.

/var/log/messages /var/log/secure /var/log/maillog /var/log/spooler /var/log/boot.log /var/log/cron {
	sharedscripts
	prerotate
		/usr/bin/greyhole-executer --prerotate
	endscript
	postrotate
		/usr/bin/greyhole-executer --postrotate > /dev/null || true
		/bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
	endscript
}

4. We need to compile our own VFS module. You'll just need to compile vfs_greyhole.c, and install it.

	Fedora:
	yumdownloader --source samba
	rpm -ivh samba-3.*.fc12.src.rpm
	cd rpmbuild/SOURCES
	tar zxf samba-3.*.tar.gz
	cd samba-3.*/source3/
	cp ${GREYHOLE_INSTALL_DIR}/samba-module/vfs_greyhole.c modules/
	./configure
	patch -p1 < ${GREYHOLE_INSTALL_DIR}/samba-module/Makefile.patch
	make
	if [ `uname -i | grep 64 | wc -l` == 1 ]; then sudo cp bin/greyhole.so /usr/lib64/samba/vfs/greyhole.so; else sudo cp bin/greyhole.so /usr/lib/samba/vfs/greyhole.so; fi
	sudo service smb restart

	Ubuntu:
	wget http://samba.org/samba/ftp/stable/samba-3.4.3.tar.gz
	tar zxf samba-3.4.3.tar.gz && rm samba-3.4.3.tar.gz
	cd samba-3.4.3/source3/modules
	wget http://www.pommepause.com/blog/wp-content/uploads/2009/12/vfs_greyhole.c
	cd ..
	./configure --cache-file=./config.cache --with-fhs --enable-shared --enable-static --disable-pie --prefix=/usr --sysconfdir=/etc --libdir=/usr/lib --with-privatedir=/etc/samba --with-piddir=/var/run/samba --localstatedir=/var --with-rootsbindir=/sbin --with-pammodulesdir=/lib/security --with-pam --with-syslog --with-utmp --with-readline --with-pam_smbpass --with-libsmbclient --with-winbind --with-shared-modules=idmap_rid,idmap_ad --with-automount --with-ldap --with-ads --with-dnsupdate --with-cifsmount --with-acl-support --with-quotas
	patch -p1 < ${GREYHOLE_INSTALL_DIR}/samba-module/Makefile.patch
	make
	sudo make install
	sudo /etc/init.d/samba restart

5. Setup Samba:

	Edit /etc/samba/smb.conf
	Change or add the following values in the [global] section:

		unix extensions = no

	For each of your shares, add a 'dfree command' and 'vfs objects' lines, as seen below.

	Example share definition:
		[share_name]
		    path = /path/to/share_name
		    create mask = 0770
		    directory mask = 0770
		    read only = no
		    available = yes
		    browseable = yes
		    writable = yes
		    guest ok = no
		    printable = no
		    dfree command = /usr/bin/greyhole-dfree
		    vfs objects = greyhole

	Note 1:
		/path/to/ will be the value of your Landing Zone in Greyhole configuration file (later).
		All your shares needs to be subdirectories of that folder, and have no space in their names.

	Fedora: sudo service smb restart
	Ubuntu: sudo /etc/init.d/samba restart

6. Setup the MySQL database:

	mysql -u root -p -e "create database greyhole; grant all on greyhole.* to greyhole_user@localhost identified by '89y63jdwe';"
	mysql -u greyhole_user -p89y63jdwe greyhole < ${GREYHOLE_INSTALL_DIR}/mysql.sql

7. Cutomize the Greyhole configuration file:

	sudo cp ${GREYHOLE_INSTALL_DIR}/greyhole.example.conf /etc/greyhole.conf
	
	Cutomize /etc/greyhole.conf as needed.

8. For each directory you defined as 'storage_pool_directories', execute the following command, while the partition is mounted:

	touch <dir>/.greyhole_uses_this

	Example: touch /mnt/hdd0/gh/.greyhole_uses_this

	Those files will be used to differentiate an empty mount from a now-gone mount.
	i.e. Greyhole will output a warning if this file is not in the root directory where it is about to try to save a file, and it won't use that directory. This will prevent Greyhole from filling the / partition when a partition is unmounted!

9. Add Greyhole to services that start on boot:

	Fedora: sudo chkconfig --add greyhole; sudo chkconfig greyhole on
	Ubuntu: sudo update-rc.d greyhole defaults 98 20

10. Work around problems with the CIFS client; edit /etc/rc.local:

	# cifs client workaround
	# Ref: http://blog.dhampir.no/content/cifs-vfs-no-response-for-cmd-n-mid
	modprobe cifs
	echo 0 > /proc/fs/cifs/OplockEnabled

11. Start the Greyhole service:

	Fedora: sudo service greyhole start
	Ubuntu: sudo /etc/init.d/greyhole start


Check for errors in the Greyhole log file: /var/log/greyhole.log


If you use any application that needs to use files on your shares, you'll need to mount the shares locally, and point those applications to those mounts.
You should not touch the files in your storage pool directories, or in your landing zone.
