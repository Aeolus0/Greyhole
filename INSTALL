Greyhole Installation Instructions
==================================

The following instructions are for Fedora 12 or Ubuntu 9/10 (see footnote 1 about Ubuntu 10).
If you know what you're doing, you should have no problem installing on any other Linux variant.

Amahi (http://www.amahi.org) comes with Greyhole pre-installed.
If you're looking for an easy way to try Greyhole, in a virtual machine or a spare computer, installing Amahi might be the easiest way to get a working Greyhole install.
More info about Greyhole on Amahi: http://wiki.amahi.org/index.php/Greyhole

Note: Samba 3.4.3 (and 3.3.9) fix a bug that affects Greyhole functionnality.
      See http://www.samba.org/samba/history/samba-3.4.3.html - BUG 6769: Fix symlink unlink. - https://bugzilla.samba.org/show_bug.cgi?id=6769
      With this bug present, trying to delete files on Greyhole shares will not work!
      Make sure the Samba version you use includes this fix, or isn't affected by this bug.
      Also, there have been reports that the Debian-bundled version of Samba would sometime show symlinks as 0-bytes files, to clients.
      If you have such issues, you should compile the latest Samba stable manually and use that.

1. Install the required applications: PHP 5 (cli) with MySQL extension, MySQL server, Samba, GCC, etc.:

	Fedora: sudo yum -y install mysql-server php php-mysql samba samba-common patch gcc rsyslog yum-utils php-pear rsync
	Ubuntu: sudo apt-get -y install mysql-server php5-cli php5-mysql samba samba-common samba-common-bin build-essential php-pear rsync

2. Install Greyhole (as root):

	Get the latest version from http://code.google.com/p/greyhole/downloads/list
	tar zxf greyhole-*.tar.gz
	cd greyhole-*
	GREYHOLE_INSTALL_DIR=`pwd`
	install -m 0755 -D -p initd_script.sh /etc/init.d/greyhole
	install -m 0755 -D -p greyhole /usr/bin
	install -m 0755 -D -p greyhole-dfree /usr/bin
	install -m 0750 -D -p greyhole-config-update /usr/bin
	install -m 0644 -D -p logrotate.greyhole /etc/logrotate.d/greyhole
	install -m 0644 -D -p greyhole.cron.d /etc/cron.d/greyhole
	if [ -x /usr/lib64/samba/vfs/ ]; then cp samba-module/bin/greyhole-x86_64.so /usr/lib64/samba/vfs/greyhole.so; else cp samba-module/bin/greyhole-i386.so /usr/lib/samba/vfs/greyhole.so; fi

	Fedora: service smb restart
	Ubuntu: /etc/init.d/samba restart, or restart smbd

3. Edit /etc/logrotate.d/syslog (or rsyslog):
	What we want is add prerotate and postrotate instructions for /var/log/messages. So add one command in the postrotate block, and add a prerotate block. When more logs than just /var/log/messages are rotated together, the sharedscripts option needs to be there.

/var/log/messages /var/log/secure /var/log/maillog /var/log/spooler /var/log/boot.log /var/log/cron {
	sharedscripts
	prerotate
		/usr/bin/greyhole --prerotate
	endscript
	postrotate
		/usr/bin/greyhole --postrotate > /dev/null || true
		/bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
	endscript
}

4. (Optional) Maybe the greyhole.so file packaged with Greyhole wouldn't work on your system. If that is so, you'll need to compile your own VFS module. You'll just need to compile vfs_greyhole.c, and install it.

	Fedora:
	yumdownloader --source samba
	rpm -ivh samba-3.*.fc12.src.rpm
	cd rpmbuild/SOURCES
	tar zxf samba-3.*.tar.gz
	cd samba-3.*/source3/

	Ubuntu:
	wget http://samba.org/samba/ftp/stable/samba-3.4.8.tar.gz
	tar zxf samba-3.*.tar.gz && rm samba-3.*.tar.gz
	cd samba-3.*/source3

	Both (Fedora & Ubuntu):
	cp ${GREYHOLE_INSTALL_DIR}/samba-module/vfs_greyhole.c modules/
	./configure
	patch -p1 < ${GREYHOLE_INSTALL_DIR}/samba-module/Makefile.patch
	make
	if [ -x /usr/lib64/samba/vfs/ ]; then sudo cp bin/greyhole.so /usr/lib64/samba/vfs/greyhole.so; else sudo cp bin/greyhole.so /usr/lib/samba/vfs/greyhole.so; fi

	Fedora: sudo service smb restart
	Ubuntu: sudo /etc/init.d/samba restart, or sudo restart smbd

5. Setup Samba:

	Edit /etc/samba/smb.conf
	Change or add the following values in the [global] section:

		unix extensions = no

	For each of your shares, add a 'dfree command' and 'vfs objects' lines, as seen below.

	Example share definition:
		[share_name]
		    path = /path/to/share_name
		    create mask = 0770
		    directory mask = 0770
		    read only = no
		    available = yes
		    browseable = yes
		    writable = yes
		    guest ok = no
		    printable = no
		    dfree command = /usr/bin/greyhole-dfree
		    vfs objects = greyhole

	Fedora: sudo service smb restart
	Ubuntu: sudo /etc/init.d/samba restart, or sudo restart smbd

6. Setup the database:

	If using MySQL:

		# Make sure your MySQL server service (mysqld) is running, and runs on boot.
		Fedora: sudo service mysqld start; sudo chkconfig mysqld on
		Ubuntu (9 only): sudo /etc/init.d/mysqld start; sudo update-rc.d mysqld defaults
		
		# Remove the -p parameter if your MySQL root user doesn't require a password for local connections.
		mysql -u root -p -e "create database greyhole; grant all on greyhole.* to greyhole_user@localhost identified by '89y63jdwe';"
		mysql -u greyhole_user -p89y63jdwe greyhole < ${GREYHOLE_INSTALL_DIR}/schema-mysql.sql

	If using SQLite:

		sqlite -u /var/cache/greyhole.db < ${GREYHOLE_INSTALL_DIR}/schema-sqlite.sql

7. Cutomize the Greyhole configuration file:

	sudo cp ${GREYHOLE_INSTALL_DIR}/greyhole.example.conf /etc/greyhole.conf
	
	Cutomize /etc/greyhole.conf as needed.

8. For each directory you defined as 'storage_pool_directories', execute the following command, while the partition is mounted:

	touch <dir>/.greyhole_uses_this

	Example: touch /mnt/hdd0/gh/.greyhole_uses_this

	Those files will be used to differentiate an empty mount from a now-gone mount.
	i.e. Greyhole will output a warning if this file is not in the root directory where it is about to try to save a file, and it won't use that directory. This will prevent Greyhole from filling the / partition when a partition is unmounted!

9. Add Greyhole to services that start on boot:

	Fedora: sudo chkconfig --add greyhole; sudo chkconfig greyhole on
	Ubuntu: sudo update-rc.d greyhole defaults 98 20

10. Work around problems with the CIFS client (as root):
    Ref: http://blog.dhampir.no/content/cifs-vfs-no-response-for-cmd-n-mid

	modprobe cifs
	echo 0 > /proc/fs/cifs/OplockEnabled
	# Make it permanent, using rc.local
	sed -ie 's/exit 0//' /etc/rc.local
	echo "modprobe cifs" >> /etc/rc.local
	echo "echo 0 > /proc/fs/cifs/OplockEnabled" >> /etc/rc.local

11. Start the Greyhole service:

	Fedora: sudo service greyhole start
	Ubuntu: sudo /etc/init.d/greyhole start


Check for errors in the Greyhole log file: /var/log/greyhole.log


If you use any application that needs to use files on your shares, you'll need to mount the shares locally, and point those applications to those mounts.
You should not touch the files in your storage pool directories.

Footnotes:

1- Ubuntu 10 seems to have changed a lot of things in how their init.d scripts work.
The init.d script included with greyhole doesn't support Ubuntu 10, but should work fine with Ubuntu 9.
If you'd like to contribute a working Greyhole Upstart or init.d script for Ubuntu 10, please contact me.
To start greyhole manually:
  ionice -c 2 -n 7 /usr/bin/greyhole --daemon > /dev/null &
